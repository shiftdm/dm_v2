<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>üìã Leads Manager</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <style>
      /* üåô General Layout */
      body {
        background: #0b0b15;
        color: #f1f1f1;
        font-family: "Segoe UI", sans-serif;
        padding: 20px;
        margin: 0;
      }
      h1 {
        color: #00b3ff;
        text-align: center;
        font-size: 2.2rem;
        margin-bottom: 20px;
      }

      /* üì¶ Sections */
      .bulk-box,
      .filter-box {
        width: 100%;
        max-width: 900px;
        margin: 20px auto;
        background: #151525;
        padding: 25px;
        border-radius: 12px;
        box-shadow: 0 0 10px rgba(0, 179, 255, 0.2);
      }
      .bulk-box p {
        text-align: center;
      }

      /* üìù Form Elements */
      textarea {
        width: 100%;
        height: 100px;
        resize: vertical;
        background: #0f0f1f;
        color: #fff;
        padding: 10px;
        border: none;
        border-radius: 6px;
        margin-bottom: 10px;
        font-size: 1rem;
      }
      input {
        background: #0f0f1f;
        color: #fff;
        border: none;
        border-radius: 5px;
        padding: 8px;
        font-size: 1rem;
        width: 100%;
      }

      button {
        background: #0078ff;
        border: none;
        color: white;
        padding: 10px 18px;
        border-radius: 6px;
        cursor: pointer;
        margin: 5px 0; /* Adjusted margin for flex group */
        font-size: 1rem;
        transition: 0.2s;
      }
      button:hover {
        background: #005ce6;
        transform: scale(1.03);
      }

      /* üîç Search Filter - New Flexbox Group */
      .flex-group {
        display: flex; /* Enable Flexbox */
        gap: 10px; /* Space between items */
        align-items: center; /* Vertically align items */
        margin-bottom: 10px;
      }
      /* Make inputs and buttons fill the space nicely */
      .flex-group input {
        flex-grow: 1; /* Allow inputs to take up space */
      }
      .flex-group button {
        flex-shrink: 0; /* Prevent buttons from shrinking */
        white-space: nowrap; /* Prevent button text from wrapping */
        padding: 10px 18px; /* Standard button padding */
        margin: 0; /* Reset margin from general button style */
      }

      /* üìã Table */
      .table-container {
        width: 100%;
        overflow-x: auto;
        margin-top: 30px;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        background: #1c1c2b;
        border-radius: 8px;
        overflow: hidden;
        min-width: 800px;
      }
      th,
      td {
        padding: 14px;
        border: 1px solid #333;
        text-align: left;
        font-size: 1rem;
      }
      th {
        background: #00b3ff22;
      }
      tr:hover {
        background: #222244;
      }
      /* Input fields in table should not grow excessively */
      td input {
        width: 100%;
        padding: 4px;
      }
      td:nth-child(2) { max-width: 150px; } /* Username */
      td:nth-child(3) { max-width: 250px; } /* Message */
      td:nth-child(6) { white-space: nowrap; } /* Actions */


      /* üçû Toasts */
      .toast {
        position: fixed;
        top: 20px;
        right: 20px;
        background: #111122;
        color: #fff;
        padding: 14px 18px;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.4);
        opacity: 0;
        transform: translateY(-20px);
        transition: all 0.3s ease;
        z-index: 1001;
      }
      .toast.show {
        opacity: 1;
        transform: translateY(0);
      }
      .toast.success {
        border-left: 5px solid #00ff99;
      }
      .toast.error {
        border-left: 5px solid #ff4c4c;
      }
      .toast.info {
        border-left: 5px solid #00b3ff;
      }

      /* ‚è≥ Loader */
      .loader {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(15, 15, 30, 0.8);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        display: none;
      }
      .spinner {
        border: 6px solid #333;
        border-top: 6px solid #00b3ff;
        border-radius: 50%;
        width: 60px;
        height: 60px;
        animation: spin 1s linear infinite;
      }
      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      /* ü™ü Confirm Box */
      .confirm-box {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(15, 15, 30, 0.85);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1002;
        display: none;
      }
      .confirm-content {
        background: #1b1b2f;
        padding: 25px;
        border-radius: 10px;
        text-align: center;
        max-width: 350px;
        width: 90%;
        box-shadow: 0 0 15px rgba(0, 179, 255, 0.4);
      }
      .confirm-content h3 {
        margin-bottom: 15px;
        color: #00b3ff;
      }
      .confirm-content p {
        margin-bottom: 20px;
        color: #ccc;
      }
      .confirm-btns {
        display: flex;
        justify-content: space-around;
      }
      .confirm-btns button {
        flex: 1;
        margin: 0 5px;
      }

      /* üîô Back Button */
      .back-btn {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        background: #1b1b2f;
        border: 1px solid #00b3ff66;
        color: #00b3ff;
        padding: 10px 18px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 1rem;
        transition: all 0.2s ease;
        margin-bottom: 15px;
      }
      .back-btn:hover {
        background: #00b3ff33;
        border-color: #00b3ff;
        transform: translateY(-2px);
      }

      @media (max-width: 700px) {
        body {
          padding: 10px;
        }
        h1 {
          font-size: 1.6rem;
        }
        .bulk-box button {
          width: 100%;
        }
        table {
          font-size: 0.9rem;
          min-width: 600px;
        }
        textarea {
          font-size: 0.9rem;
        }

        /* üì± Mobile Layout: Stack inputs/buttons */
        .flex-group {
          flex-direction: column;
        }
        .flex-group input,
        .flex-group button {
          width: 100%;
          margin: 5px 0;
        }
      }
    </style>
  </head>

  <body>
    <button class="back-btn" onclick="window.location.href='/'">‚¨ÖÔ∏è Back to Home</button>
    <h1>üìã Leads Management</h1>

    <div class="bulk-box">
      <h3>üßæ Add Bulk Leads</h3>
      <p>Enter each line as: <b>username,message</b></p>
      <textarea
        id="bulkData"
        placeholder="user1,Hello there
user2,Hey welcome!"
      ></textarea>
      <br />
      <div style="text-align: center;">
        <button onclick="addBulk()">‚ûï Add Leads</button>
      </div>
    </div>

    <div class="filter-box">
      <h3>üóëÔ∏è Delete Leads by Status</h3>
      <div class="flex-group">
        <input id="filterStatus" placeholder="e.g. null, sent, failed, not-send" />
        <button onclick="deleteByStatus()">Delete</button>
      </div>
    </div>

    <div class="filter-box">
      <h3>üîç Search & Filter Leads</h3>
      <div class="flex-group">
        <input id="searchUser" placeholder="Search by username..." />
        <input id="searchStatus" placeholder="Search by status..." />
        <button onclick="clearFilter()">Clear</button>
      </div>
    </div>

    <hr />
    <h3 style="text-align: center">All Leads</h3>

    <div class="table-container">
      <table>
        <tr>
          <th>ID</th>
          <th>Username</th>
          <th>Message</th>
          <th>Status</th>
          <th>Timestamp</th>
          <th>Actions</th>
        </tr>
        <% if (leads.length === 0) { %>
        <tr>
          <td colspan="6" style="text-align:center; color:#bbb;">No leads found</td>
        </tr>
        <% } else { %>
        <% leads.forEach((lead) => { %>
        <tr>
          <td><%= lead.id %></td>
          <td><input id="u<%= lead.id %>" value="<%- lead.username || '' %>" /></td>
          <td><input id="m<%= lead.id %>" value="<%- lead.message || '' %>" /></td>
          <td><input id="s<%= lead.id %>" value="<%- lead.status || '' %>" /></td>
          <td><%= lead.time_stamp || '-' %></td>
          <td>
            <button onclick="updateLead(<%= lead.id %>)">‚úèÔ∏è Update</button>
            <button onclick="confirmDelete(<%= lead.id %>)">üóëÔ∏è Delete</button>
          </td>
        </tr>
        <% }) %>
        <% } %>
      </table>
    </div>

    <div id="loader" class="loader"><div class="spinner"></div></div>

    <div id="confirmBox" class="confirm-box">
      <div class="confirm-content">
        <h3>‚ö†Ô∏è Confirm Delete</h3>
        <p>Are you sure you want to delete this lead?</p>
        <div class="confirm-btns">
          <button onclick="handleConfirm(true)">Yes, Delete</button>
          <button onclick="handleConfirm(false)">Cancel</button>
        </div>
      </div>
    </div>

    <script>
      const loader = document.getElementById("loader");
      const confirmBox = document.getElementById("confirmBox");
      let confirmResolve;

      const showLoader = () => (loader.style.display = "flex");
      const hideLoader = () => (loader.style.display = "none");

      const showToast = (msg, type = "info") => {
        const toast = document.createElement("div");
        toast.className = `toast ${type}`;
        toast.textContent = msg;
        document.body.appendChild(toast);
        setTimeout(() => toast.classList.add("show"), 100);
        setTimeout(() => {
          toast.classList.remove("show");
          setTimeout(() => toast.remove(), 300);
        }, 3000);
      };

      function showConfirm() {
        confirmBox.style.display = "flex";
        return new Promise((res) => (confirmResolve = res));
      }
      function handleConfirm(result) {
        confirmBox.style.display = "none";
        confirmResolve(result);
      }

      async function confirmDelete(id) {
        const confirmed = await showConfirm();
        if (confirmed) deleteLead(id);
      }

      async function addBulk() {
        const data = document.getElementById("bulkData").value.trim();
        if (!data) return showToast("‚ö†Ô∏è No data entered!", "error");
        showLoader();
        try {
          // Assuming an API endpoint like this:
          const res = await fetch("/leads/add", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ data }),
          });
          const result = await res.json();
          if (result.success) {
            showToast(`‚úÖ Added ${result.added} leads!`, "success");
            setTimeout(() => location.reload(), 1000);
          } else showToast("‚ùå " + (result.error || "Error adding leads"), "error");
        } catch {
          showToast("‚ö†Ô∏è Network error!", "error");
        } finally {
          hideLoader();
        }
      }

      async function updateLead(id) {
        const username = document.getElementById("u" + id).value;
        const message = document.getElementById("m" + id).value;
        const status = document.getElementById("s" + id).value;
        showLoader();
        try {
          // Assuming an API endpoint like this:
          const res = await fetch(`/leads/update/${id}`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ username, message, status }),
          });
          const result = await res.json();
          if (result.success) showToast("‚úÖ Lead updated!", "success");
          else showToast("‚ùå Update failed!", "error");
        } catch {
          showToast("‚ö†Ô∏è Network error!", "error");
        } finally {
          hideLoader();
        }
      }

      async function deleteLead(id) {
        showLoader();
        try {
          // Assuming an API endpoint like this:
          const res = await fetch(`/leads/delete/${id}`, { method: "POST" });
          const result = await res.json();
          if (result.success) {
            showToast("üóëÔ∏è Lead deleted!", "success");
            setTimeout(() => location.reload(), 1000);
          } else showToast("‚ùå Failed to delete!", "error");
        } catch {
          showToast("‚ö†Ô∏è Network error!", "error");
        } finally {
          hideLoader();
        }
      }

      async function deleteByStatus() {
        const status = document.getElementById("filterStatus").value.trim();
        if (!status) return showToast("‚ö†Ô∏è Enter a status!", "error");
        
        // Custom confirmation message for bulk deletion
        const confirmed = await showConfirm();
        if (!confirmed) return;

        showLoader();
        try {
          // Assuming an API endpoint like this:
          const res = await fetch(`/leads/delete-filter`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ status }),
          });
          const result = await res.json(); // Assuming the backend returns success/count
          showToast(`‚úÖ Deleted leads with status "${status}"!`, "success");
          setTimeout(() => location.reload(), 1000);
        } catch {
          showToast("‚ö†Ô∏è Network error!", "error");
        } finally {
          hideLoader();
        }
      }

      // üîç Dynamic Filter Logic
      const searchUser = document.getElementById("searchUser");
      const searchStatus = document.getElementById("searchStatus");

      function filterLeads() {
        const userVal = searchUser.value.toLowerCase().trim();
        const statusVal = searchStatus.value.toLowerCase().trim();
        const rows = document.querySelectorAll(".table-container table tr");

        rows.forEach((row, i) => {
          if (i === 0) return; // Skip header row
          // Use querySelector to safely get the input value in the second and fourth columns
          const user = row.querySelector("td:nth-child(2) input")?.value.toLowerCase() || "";
          const status = row.querySelector("td:nth-child(4) input")?.value.toLowerCase() || "";
          
          const matchUser = !userVal || user.includes(userVal);
          const matchStatus = !statusVal || status.includes(statusVal);
          
          // Show the row if both filters match, otherwise hide it.
          row.style.display = matchUser && matchStatus ? "" : "none";
        });
      }

      function clearFilter() {
        searchUser.value = "";
        searchStatus.value = "";
        filterLeads();
      }

      searchUser.addEventListener("input", filterLeads);
      searchStatus.addEventListener("input", filterLeads);
    </script>
  </body>
</html>